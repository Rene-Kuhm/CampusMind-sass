// CampusMind Database Schema
// PostgreSQL with pgvector extension for embeddings

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  profile        UserProfile?
  subjects       Subject[]
  queries        RagQuery[]
  studyEvents    StudyEvent[]
  flashcardDecks FlashcardDeck[]
  subscription   Subscription?

  @@map("users")
}

model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  career    String? // Carrera universitaria
  year      Int? // Año de cursada
  university String?

  // Preferencias de estudio
  studyStyle    StudyStyle @default(BALANCED) @map("study_style")
  contentDepth  ContentDepth @default(INTERMEDIATE) @map("content_depth")
  preferredLang String @default("es") @map("preferred_lang")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

enum StudyStyle {
  FORMAL      // Más académico, formal
  PRACTICAL   // Más práctico, ejemplos
  BALANCED    // Equilibrado
}

enum ContentDepth {
  BASIC        // Introductorio
  INTERMEDIATE // Intermedio
  ADVANCED     // Avanzado
}

// ============================================
// SUBJECTS (MATERIAS/WORKSPACES)
// ============================================

model Subject {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  description String?
  career      String?
  year        Int?
  semester    String?
  color       String?  @default("#6366f1") // Color para UI
  isArchived  Boolean  @default(false) @map("is_archived")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  resources      Resource[]
  queries        RagQuery[]
  studyEvents    StudyEvent[]
  flashcardDecks FlashcardDeck[]

  @@index([userId])
  @@map("subjects")
}

// ============================================
// ACADEMIC RESOURCES
// ============================================

model Resource {
  id          String       @id @default(cuid())
  subjectId   String       @map("subject_id")

  // Metadata básica
  title       String
  authors     String[]     @default([])
  description String?
  url         String?      // Enlace externo

  // Clasificación
  type        ResourceType
  level       ResourceLevel @default(INTERMEDIATE)
  language    String        @default("es")

  // Licencia y acceso
  isOpenAccess Boolean      @default(true) @map("is_open_access")
  license      String?      // CC-BY, MIT, etc.

  // Fuente externa (si viene de API académica)
  externalId   String?      @map("external_id") // ID en OpenAlex, Semantic Scholar, etc.
  externalSource String?    @map("external_source") // openalex, semantic_scholar, crossref

  // Estado de indexación RAG
  isIndexed    Boolean      @default(false) @map("is_indexed")
  indexedAt    DateTime?    @map("indexed_at")
  chunkCount   Int          @default(0) @map("chunk_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subject     Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  chunks      ResourceChunk[]
  notes       ResourceNote[]
  studyEvents StudyEvent[]

  @@index([subjectId])
  @@index([externalId, externalSource])
  @@map("resources")
}

enum ResourceType {
  BOOK
  PAPER
  ARTICLE
  VIDEO
  COURSE
  MANUAL
  NOTES
  OTHER
}

enum ResourceLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
}

// Notas del usuario sobre un recurso
model ResourceNote {
  id         String   @id @default(cuid())
  resourceId String   @map("resource_id")
  content    String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@map("resource_notes")
}

// ============================================
// RAG - CHUNKS & EMBEDDINGS
// ============================================

model ResourceChunk {
  id         String   @id @default(cuid())
  resourceId String   @map("resource_id")

  content    String   // Texto del chunk
  metadata   Json?    // Página, sección, timestamp, etc.
  chunkIndex Int      @map("chunk_index")

  // Vector embedding (pgvector)
  // Dimensión 1536 para text-embedding-3-small de OpenAI
  embedding  Unsupported("vector(1536)")?

  createdAt DateTime @default(now()) @map("created_at")

  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@index([resourceId])
  @@map("resource_chunks")
}

// ============================================
// RAG QUERIES LOG
// ============================================

model RagQuery {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  subjectId String?  @map("subject_id")

  query     String   // Pregunta del usuario
  response  String?  // Respuesta generada

  // Chunks usados para la respuesta
  chunksUsed Json?   @map("chunks_used") // Array de chunk IDs + scores

  // Métricas
  tokensUsed    Int?     @map("tokens_used")
  responseTimeMs Int?    @map("response_time_ms")

  createdAt DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subjectId])
  @@map("rag_queries")
}

// ============================================
// STUDY CALENDAR & EVENTS
// ============================================

model StudyEvent {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")

  title       String
  description String?

  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")

  type        StudyEventType @default(STUDY_SESSION)

  // Asociaciones opcionales
  subjectId   String?  @map("subject_id")
  resourceId  String?  @map("resource_id")

  // Personalización
  color       String?

  // Recurrencia
  recurrence  RecurrenceType @default(NONE)

  // Recordatorio
  reminderMinutes Int?  @map("reminder_minutes")

  // Estado
  isAllDay    Boolean  @default(false) @map("is_all_day")
  isCompleted Boolean  @default(false) @map("is_completed")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject   Subject?  @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  resource  Resource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([subjectId])
  @@index([startTime, endTime])
  @@map("study_events")
}

enum StudyEventType {
  STUDY_SESSION
  REVIEW
  EXAM
  DEADLINE
  CLASS
  BREAK
}

enum RecurrenceType {
  NONE
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

// ============================================
// FLASHCARDS & SPACED REPETITION
// ============================================

model FlashcardDeck {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  name        String
  description String?
  subjectId   String?  @map("subject_id")
  color       String?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject     Subject?    @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  flashcards  Flashcard[]

  @@index([userId])
  @@index([subjectId])
  @@map("flashcard_decks")
}

model Flashcard {
  id          String   @id @default(cuid())
  deckId      String   @map("deck_id")

  front       String   // Pregunta o frente de la tarjeta
  back        String   // Respuesta o reverso
  formula     String?  // Fórmula/código opcional
  tags        String[] @default([])

  // SM-2 Spaced Repetition Algorithm fields
  repetitions Int      @default(0)
  easeFactor  Float    @default(2.5) @map("ease_factor")
  interval    Int      @default(0)   // Days until next review
  nextReviewDate DateTime @default(now()) @map("next_review_date")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  deck        FlashcardDeck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviews     FlashcardReview[]

  @@index([deckId])
  @@index([nextReviewDate])
  @@map("flashcards")
}

model FlashcardReview {
  id          String   @id @default(cuid())
  flashcardId String   @map("flashcard_id")

  quality     Int      // 1-5 scale (SM-2)
  interval    Int      // Days until next review at time of review
  easeFactor  Float    @map("ease_factor")

  createdAt   DateTime @default(now()) @map("created_at")

  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@index([flashcardId])
  @@index([createdAt])
  @@map("flashcard_reviews")
}

// ============================================
// QUIZZES & EXAM SIMULATIONS
// ============================================

model Quiz {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  title            String
  description      String?
  subjectId        String?  @map("subject_id")

  timeLimitMinutes Int?     @map("time_limit_minutes")
  passingScore     Int      @default(60) @map("passing_score") // Percentage
  showAnswers      Boolean  @default(true) @map("show_answers")
  shuffleQuestions Boolean  @default(false) @map("shuffle_questions")

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  questions        QuizQuestion[]
  attempts         QuizAttempt[]

  @@index([userId])
  @@index([subjectId])
  @@map("quizzes")
}

model QuizQuestion {
  id            String   @id @default(cuid())
  quizId        String   @map("quiz_id")

  text          String
  type          QuestionType
  options       Json?    // Array of { id, text, isCorrect }
  correctAnswer String?  @map("correct_answer") // For short answer/essay
  explanation   String?
  difficulty    DifficultyLevel @default(MEDIUM)
  points        Int      @default(1)
  order         Int      @default(0)

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@map("quiz_questions")
}

model QuizAttempt {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  quizId           String   @map("quiz_id")

  answers          Json     // Array of graded answers
  score            Int
  totalPoints      Int      @map("total_points")
  percentage       Float
  passed           Boolean
  timeSpentMinutes Int?     @map("time_spent_minutes")

  completedAt      DateTime @default(now()) @map("completed_at")

  quiz             Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

// ============================================
// BILLING & SUBSCRIPTIONS
// ============================================

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")

  // Plan info
  plan      PlanType @default(FREE)
  status    SubscriptionStatus @default(ACTIVE)

  // Payment provider info
  provider           PaymentProvider?
  providerCustomerId String?  @map("provider_customer_id") // MP customer_id or LS customer_id
  providerSubscriptionId String? @map("provider_subscription_id") // MP preapproval_id or LS subscription_id

  // Billing dates
  currentPeriodStart DateTime? @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end")
  cancelAtPeriodEnd  Boolean   @default(false) @map("cancel_at_period_end")

  // Trial
  trialEndsAt DateTime? @map("trial_ends_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]
  usages   UsageRecord[]

  @@index([providerCustomerId])
  @@index([providerSubscriptionId])
  @@map("subscriptions")
}

model Payment {
  id             String   @id @default(cuid())
  subscriptionId String   @map("subscription_id")

  // Payment details
  amount         Int      // Amount in cents
  currency       String   @default("ARS")
  status         PaymentStatus

  // Provider info
  provider          PaymentProvider
  providerPaymentId String?  @map("provider_payment_id") // MP payment_id or LS order_id
  providerInvoiceId String?  @map("provider_invoice_id")

  // Metadata
  description    String?
  metadata       Json?

  // Dates
  paidAt         DateTime? @map("paid_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([providerPaymentId])
  @@map("payments")
}

model UsageRecord {
  id             String   @id @default(cuid())
  subscriptionId String   @map("subscription_id")

  // Usage type
  type           UsageType
  count          Int      @default(0)

  // Period
  periodStart    DateTime @map("period_start")
  periodEnd      DateTime @map("period_end")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, type, periodStart])
  @@index([subscriptionId])
  @@map("usage_records")
}

enum PlanType {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELLED
  EXPIRED
  PAUSED
}

enum PaymentProvider {
  MERCADOPAGO
  LEMONSQUEEZY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

enum UsageType {
  RAG_QUERIES
  FLASHCARDS
  STORAGE_MB
  SUBJECTS
}
